<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆãƒ†ã‚¹ãƒˆ - åœ°å›³â†’CSVåŒ–æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
        }
        .test-panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®HTMLï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div style="display: none;">
        <div class="map-container">
            <div id="map" style="height: 400px;"></div>
        </div>
        <div id="uploadArea"></div>
        <input type="file" id="fileInput">
        <div id="uploadedImage" style="display: none;">
            <img id="previewImage" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        </div>
        <input type="text" id="addressInput">
        <button id="searchAddress">åœ°å›³ã‚’ç§»å‹•</button>
        <div id="overlaySection" style="display: none;">
            <div id="imagePoints"></div>
            <div id="mapPoints"></div>
            <button id="applyTransform">ä½ç½®åˆã‚ã›ã‚’å®Ÿè¡Œ</button>
            <button id="resetPoints">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="rightSidebar" style="display: none;">
            <div id="pinSection" style="display: none;">
                <div id="pinList"></div>
                <input type="text" id="prefectureInput">
                <input type="text" id="cityInput">
                <button id="exportCsv">CSVå‡ºåŠ›</button>
            </div>
        </div>
        <div id="pinModal" style="display: none;">
            <select id="pinDisplayNumber">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <input type="text" id="pinNumber">
            <input type="text" id="pinName">
            <textarea id="pinMemo"></textarea>
            <button id="savePinInfo">ä¿å­˜</button>
            <button id="cancelPinInfo">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <canvas id="imageCanvas" style="display: none;"></canvas>
        </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="test-overlay" id="testOverlay">
        <div class="test-panel">
            <h2>ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­</h2>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="testResults"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="closeTestPanel()">ãƒ†ã‚¹ãƒˆå®Œäº†</button>
            </div>
        </div>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="module">
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        let initializationComplete = false;
        
        // æ—©æœŸã®ãƒ­ã‚°å‡ºåŠ›ç”¨é–¢æ•°
        function earlyLog(type, message) {
            const container = document.getElementById('testResults');
            if (container) {
                const result = document.createElement('div');
                result.className = `test-result ${type}`;
                result.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
                container.appendChild(result);
            }
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function initializeTestApp() {
            try {
                console.log('ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚’é–‹å§‹...');
                earlyLog('info', 'ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚’é–‹å§‹...');
                
                // main.jsã‹ã‚‰ç›´æ¥Appã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                console.log('ğŸ“¦ main.jsã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
                const mainModule = await import('./js/main.js');
                console.log('ğŸ“¦ main.jsã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:', Object.keys(mainModule));
                
                const App = mainModule.default;
                
                if (!App) {
                    throw new Error(`Appã‚¯ãƒ©ã‚¹ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆ©ç”¨å¯èƒ½: ${Object.keys(mainModule)}`);
                }
                
                console.log('âœ… Appã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ');
                earlyLog('info', 'âœ… Appã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ');
                
                // Appã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                console.log('ğŸ—ï¸ Appã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆä¸­...');
                
                // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
                const criticalElements = ['map', 'uploadArea', 'fileInput', 'overlaySection'];
                const missingElements = criticalElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    throw new Error(`é‡è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missingElements.join(', ')}`);
                }
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¦Appã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
                let appInitError = null;
                const originalError = window.onerror;
                window.onerror = function(message, source, lineno, colno, error) {
                    appInitError = error || new Error(message);
                    earlyLog('error', `ğŸš¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼æ•æ‰: ${message} at ${source}:${lineno}`);
                    return true; // ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
                };
                
                try {
                    // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å…¥åŠ›å±¥æ­´ã®åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    window.testApp = new App({ skipInputHistory: true });
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (appInitError) {
                        throw appInitError;
                    }
                } finally {
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å…ƒã«æˆ»ã™
                    window.onerror = originalError;
                }
                console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                earlyLog('info', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                
                // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–ã‚’ç¢ºèª
                console.log('ğŸ” ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¢ºèª:', {
                    mapManager: !!window.testApp.mapManager,
                    imageUploader: !!window.testApp.imageUploader,
                    overlayManager: !!window.testApp.overlayManager,
                    pinManager: !!window.testApp.pinManager,
                    csvExporter: !!window.testApp.csvExporter,
                    inputHistoryManager: !!window.testApp.inputHistoryManager
                });
                
                // åœ°å›³ã®åˆæœŸåŒ–ã‚’æ®µéšçš„ã«ç¢ºèª
                let initAttempts = 0;
                const checkInitialization = () => {
                    initAttempts++;
                    
                    if (window.testApp && window.testApp.mapManager && window.testApp.mapManager.map) {
                        initializationComplete = true;
                        console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
                        earlyLog('info', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
                    } else if (initAttempts >= 20) { // 4ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                        initializationComplete = true;
                        console.log('âš ï¸ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ†ã‚¹ãƒˆã‚’ç¶šè¡Œã—ã¾ã™');
                        earlyLog('warning', 'âš ï¸ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ†ã‚¹ãƒˆã‚’ç¶šè¡Œã—ã¾ã™');
                    } else {
                        if (initAttempts % 5 === 0) {
                            console.log(`ğŸ”„ åˆæœŸåŒ–ç¢ºèªä¸­... (${initAttempts}/20)`);
                            earlyLog('info', `ğŸ”„ åˆæœŸåŒ–ç¢ºèªä¸­... (${initAttempts}/20)`);
                        }
                        setTimeout(checkInitialization, 200);
                    }
                };
                
                setTimeout(checkInitialization, 500);
                
            } catch (error) {
                console.error('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—:', error);
                earlyLog('error', `âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                window.testApp = null;
                initializationComplete = false;
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            earlyLog('error', `ğŸš¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error.message}`);
        });
        
        // åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        await initializeTestApp();

        let testProgress = 0;
        const totalTests = 8;

        function addTestResult(type, message) {
            const container = document.getElementById('testResults');
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(result);
            container.scrollTop = container.scrollHeight;
        }

        function updateProgress() {
            testProgress++;
            const percentage = (testProgress / totalTests) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        window.runAllTests = async function() {
            testProgress = 0;
            document.getElementById('testResults').innerHTML = '';
            
            addTestResult('info', 'ğŸš€ çµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');

            // ãƒ†ã‚¹ãƒˆ1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª
            try {
                const { CONFIG } = await import('./js/config.js');
                const { ErrorHandler } = await import('./js/utils/error-handler.js');
                
                if (CONFIG && ErrorHandler) {
                    addTestResult('success', 'âœ… ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿æˆåŠŸ');
                } else {
                    addTestResult('error', 'âŒ ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿å¤±æ•—');
                }
            } catch (error) {
                addTestResult('error', `âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ2: è¨­å®šå€¤ç¢ºèª
            try {
                const { CONFIG } = await import('./js/config.js');
                
                const configTests = [
                    ['ãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚º', CONFIG.UI.MARKER_SIZES.DEFAULT.length === 2],
                    ['åœ°å›³ä¸­å¿ƒåº§æ¨™', Array.isArray(CONFIG.MAP.DEFAULT_CENTER)],
                    ['å±¥æ­´æœ€å¤§ä»¶æ•°', typeof CONFIG.HISTORY.MAX_ENTRIES === 'number'],
                ];

                let configOk = true;
                for (const [name, passed] of configTests) {
                    if (!passed) {
                        addTestResult('error', `âŒ è¨­å®šã‚¨ãƒ©ãƒ¼: ${name}`);
                        configOk = false;
                    }
                }
                
                if (configOk) {
                    addTestResult('success', 'âœ… è¨­å®šå€¤ã®æ•´åˆæ€§ç¢ºèªå®Œäº†');
                }
            } catch (error) {
                addTestResult('error', `âŒ è¨­å®šå€¤ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ3: DOMè¦ç´ å­˜åœ¨ç¢ºèª
            try {
                const requiredElements = [
                    'map', 'uploadArea', 'fileInput', 'addressInput', 'searchAddress',
                    'overlaySection', 'imagePoints', 'mapPoints', 'applyTransform', 'resetPoints',
                    'rightSidebar', 'pinSection', 'pinList', 'pinModal',
                    'pinDisplayNumber', 'pinNumber', 'pinName', 'pinMemo',
                    'savePinInfo', 'cancelPinInfo', 'exportCsv',
                    'prefectureInput', 'cityInput', 'imageCanvas'
                ];

                let missingElements = [];
                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        missingElements.push(elementId);
                    }
                }

                if (missingElements.length === 0) {
                    addTestResult('success', 'âœ… å¿…è¦ãªDOMè¦ç´ ãŒå…¨ã¦å­˜åœ¨');
                } else {
                    addTestResult('warning', `âš ï¸ ä¸€éƒ¨è¦ç´ ãŒä¸è¶³: ${missingElements.join(', ')}`);
                    
                    // ä¸è¶³ã—ã¦ã„ã‚‹è¦ç´ ã‚’å‹•çš„ã«ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
                    missingElements.forEach(elementId => {
                        if (!document.getElementById(elementId)) {
                            let element;
                            
                            // è¦ç´ ã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªè¦ç´ ã‚’ä½œæˆ
                            if (elementId.includes('Input') || elementId.includes('Address')) {
                                element = document.createElement('input');
                                element.type = 'text';
                            } else if (elementId.includes('Button') || elementId === 'searchAddress') {
                                element = document.createElement('button');
                            } else if (elementId === 'pinDisplayNumber') {
                                element = document.createElement('select');
                            } else if (elementId === 'pinMemo') {
                                element = document.createElement('textarea');
                            } else if (elementId === 'imageCanvas') {
                                element = document.createElement('canvas');
                            } else {
                                element = document.createElement('div');
                            }
                            
                            element.id = elementId;
                            element.style.display = 'none';
                            
                            // è¦ªã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¦è¿½åŠ 
                            const container = document.createElement('div');
                            container.style.display = 'none';
                            container.appendChild(element);
                            document.body.appendChild(container);
                        }
                    });
                    
                    addTestResult('info', 'â„¹ï¸ ä¸è¶³ã—ã¦ã„ãŸè¦ç´ ã‚’ãƒ†ã‚¹ãƒˆç”¨ã«å‹•çš„ä½œæˆã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addTestResult('error', `âŒ DOMè¦ç´ ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ4: åœ°å›³åˆæœŸåŒ–ç¢ºèª
            try {
                addTestResult('info', 'ğŸ”„ åœ°å›³åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                
                // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚’å¾…ã¤ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
                const initPromise = new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 100; // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    
                    const checkInitialization = () => {
                        attempts++;
                        
                        if (initializationComplete && window.testApp && window.testApp.mapManager) {
                            addTestResult('info', `âœ… åˆæœŸåŒ–å®Œäº†ç¢ºèª (${attempts}å›ç›®ã€${attempts * 100}ms)`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            addTestResult('warning', `âš ï¸ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (${attempts * 100}ms): testApp=${!!window.testApp}, mapManager=${!!(window.testApp && window.testApp.mapManager)}, å®Œäº†=${initializationComplete}`);
                            resolve(); // ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãè­¦å‘Šã¨ã—ã¦ç¶šè¡Œ
                        } else {
                            if (attempts % 10 === 0) {
                                addTestResult('info', `ğŸ”„ åˆæœŸåŒ–å¾…æ©Ÿä¸­... (${attempts}å›ç›®ã€${attempts * 100}ms)`);
                            }
                            setTimeout(checkInitialization, 100);
                        }
                    };
                    checkInitialization();
                });
                
                await initPromise;
                
                // æ®µéšçš„è¨ºæ–­
                addTestResult('info', `ğŸ” testAppå­˜åœ¨: ${!!window.testApp}`);
                
                if (window.testApp) {
                    addTestResult('info', `ğŸ” testAppå­˜åœ¨: ${!!window.testApp}`);
                    addTestResult('info', `ğŸ” mapManagerå­˜åœ¨: ${!!window.testApp.mapManager}`);
                    
                    if (window.testApp.mapManager) {
                        addTestResult('info', `ğŸ” mapå­˜åœ¨: ${!!window.testApp.mapManager.map}`);
                        
                        if (window.testApp.mapManager.map) {
                            const map = window.testApp.mapManager.map;
                            addTestResult('info', 'ğŸ” åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç¢ºèªæ¸ˆã¿');
                            
                            try {
                                const center = map.getCenter();
                                addTestResult('info', `ğŸ” ä¸­å¿ƒåº§æ¨™å–å¾—: ${!!center}`);
                                
                                if (center && typeof center.lat === 'number' && typeof center.lng === 'number') {
                                    addTestResult('success', `âœ… åœ°å›³åˆæœŸåŒ–æˆåŠŸ: ä¸­å¿ƒåº§æ¨™ (${center.lat.toFixed(4)}, ${center.lng.toFixed(4)})`);
                                } else {
                                    addTestResult('warning', `âš ï¸ ä¸­å¿ƒåº§æ¨™ãŒç„¡åŠ¹: ${JSON.stringify(center)}`);
                                }
                            } catch (centerError) {
                                addTestResult('warning', `âš ï¸ ä¸­å¿ƒåº§æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼: ${centerError.message}`);
                            }
                        } else {
                            addTestResult('warning', 'âš ï¸ åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆLeafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å•é¡Œã®å¯èƒ½æ€§ï¼‰');
                        }
                    } else {
                        addTestResult('warning', 'âš ï¸ MapManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                    
                    // ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç¢ºèª
                    const components = ['imageUploader', 'overlayManager', 'pinManager', 'csvExporter', 'inputHistoryManager'];
                    const availableComponents = components.filter(comp => !!window.testApp[comp]);
                    addTestResult('info', `ğŸ” åˆ©ç”¨å¯èƒ½ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ${availableComponents.join(', ')}`);
                    
                } else {
                    addTestResult('error', 'âŒ testAppãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
            } catch (error) {
                addTestResult('error', `âŒ åœ°å›³åˆæœŸåŒ–ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ5: åº§æ¨™å¤‰æ›æ©Ÿèƒ½ç¢ºèª
            try {
                const { CoordinateTransformer } = await import('./js/utils/coordinate-transformer.js');
                
                const testTransform = CoordinateTransformer.calculateTransform(
                    { x: 0, y: 0 }, { x: 100, y: 100 },
                    { lat: 35.0, lng: 135.0 }, { lat: 35.001, lng: 135.001 }
                );

                if (testTransform && typeof testTransform.scaleX === 'number') {
                    addTestResult('success', 'âœ… åº§æ¨™å¤‰æ›æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ');
                } else {
                    addTestResult('error', 'âŒ åº§æ¨™å¤‰æ›æ©Ÿèƒ½ã«å•é¡Œã‚ã‚Š');
                }
            } catch (error) {
                addTestResult('error', `âŒ åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ6: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
            try {
                const { ErrorHandler } = await import('./js/utils/error-handler.js');
                
                // éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
                const testAsync = await ErrorHandler.handleAsyncOperation(async () => {
                    return "ãƒ†ã‚¹ãƒˆæˆåŠŸ";
                }, 'ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ').catch(() => null);

                if (testAsync === "ãƒ†ã‚¹ãƒˆæˆåŠŸ") {
                    addTestResult('success', 'âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸');
                } else {
                    addTestResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã«å•é¡Œ');
                }
            } catch (error) {
                addTestResult('error', `âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ7: å…¥åŠ›å±¥æ­´æ©Ÿèƒ½ç¢ºèª
            try {
                const { InputHistoryManager } = await import('./js/input-history.js');
                
                const historyManager = new InputHistoryManager();
                historyManager.addToHistory('test', 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿');
                const history = historyManager.getHistory('test');

                if (history.length > 0 && history[0] === 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿') {
                    addTestResult('success', 'âœ… å…¥åŠ›å±¥æ­´æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ');
                } else {
                    addTestResult('error', 'âŒ å…¥åŠ›å±¥æ­´æ©Ÿèƒ½ã«å•é¡Œã‚ã‚Š');
                }
                
                // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®å…¥åŠ›å±¥æ­´ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
                if (window.testApp && window.testApp.inputHistoryManager === null) {
                    addTestResult('info', 'â„¹ï¸ ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å…¥åŠ›å±¥æ­´ã®åˆæœŸåŒ–ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ');
                } else if (window.testApp && window.testApp.inputHistoryManager) {
                    addTestResult('success', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®å…¥åŠ›å±¥æ­´ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚‚æ­£å¸¸');
                }
            } catch (error) {
                addTestResult('error', `âŒ å…¥åŠ›å±¥æ­´ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆ8: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç·åˆç¢ºèª
            try {
                if (window.testApp) {
                    const components = [
                        'mapManager', 'imageUploader', 'overlayManager', 
                        'pinManager', 'csvExporter', 'inputHistoryManager'
                    ];

                    const availableComponents = [];
                    const missingComponents = [];
                    
                    for (const component of components) {
                        if (window.testApp[component]) {
                            availableComponents.push(component);
                        } else {
                            missingComponents.push(component);
                        }
                    }

                    if (availableComponents.length === components.length) {
                        addTestResult('success', 'âœ… å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–å®Œäº†');
                    } else if (availableComponents.length > 0) {
                        addTestResult('warning', `âš ï¸ ä¸€éƒ¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸è¶³: ${missingComponents.join(', ')}`);
                        addTestResult('info', `â„¹ï¸ åˆ©ç”¨å¯èƒ½: ${availableComponents.join(', ')}`);
                    } else {
                        addTestResult('error', 'âŒ å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã«å¤±æ•—');
                    }
                    
                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    addTestResult('info', `â„¹ï¸ testApp: ${typeof window.testApp}, åˆæœŸåŒ–å®Œäº†: ${initializationComplete}`);
                    
                    // å®Ÿéš›ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                    if (window.testApp.inputHistoryManager) {
                        try {
                            window.testApp.inputHistoryManager.addToHistory('test', 'ãƒ†ã‚¹ãƒˆå€¤');
                            const history = window.testApp.inputHistoryManager.getHistory('test');
                            if (history.length > 0) {
                                addTestResult('success', 'âœ… å…¥åŠ›å±¥æ­´æ©Ÿèƒ½ãŒå®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                            }
                        } catch (historyError) {
                            addTestResult('warning', 'âš ï¸ å…¥åŠ›å±¥æ­´æ©Ÿèƒ½ã«ã‚¨ãƒ©ãƒ¼: ' + historyError.message);
                        }
                    }
                    
                } else {
                    addTestResult('error', `âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç•°å¸¸: testApp=${typeof window.testApp}`);
                }
            } catch (error) {
                addTestResult('error', `âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            updateProgress();

            // ãƒ†ã‚¹ãƒˆå®Œäº†
            const endTime = new Date();
            addTestResult('info', `ğŸ‰ çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼[${endTime.toLocaleTimeString()}] çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            
            // çµæœã‚µãƒãƒªãƒ¼
            const results = document.querySelectorAll('.test-result');
            const successCount = document.querySelectorAll('.test-result.success').length;
            const errorCount = document.querySelectorAll('.test-result.error').length;
            const warningCount = document.querySelectorAll('.test-result.warning').length;
            
            addTestResult('info', `ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼: æˆåŠŸ=${successCount}, è­¦å‘Š=${warningCount}, ã‚¨ãƒ©ãƒ¼=${errorCount}`);
            
            if (errorCount === 0) {
                addTestResult('success', 'ğŸŠ å…¨ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼');
            } else if (errorCount < 3) {
                addTestResult('warning', 'âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã—ãŸãŒã€åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ä½œã—ã¦ã„ã¾ã™');
            } else {
                addTestResult('error', 'âŒ è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç¢ºèªãŒå¿…è¦ã§ã™');
            }
        };

        window.closeTestPanel = function() {
            document.getElementById('testOverlay').style.display = 'none';
        };

        // è‡ªå‹•å®Ÿè¡Œï¼ˆåˆæœŸåŒ–å®Œäº†ã‚’å¾…ã¤ï¼‰
        function waitAndRunTests() {
            let attempts = 0;
            const maxWaitAttempts = 50; // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            
            const checkAndRun = () => {
                attempts++;
                if (initializationComplete) {
                    setTimeout(() => {
                        runAllTests();
                    }, 500);
                } else if (attempts >= maxWaitAttempts) {
                    earlyLog('warning', 'âš ï¸ åˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿä¸­ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ†ã‚¹ãƒˆã‚’å¼·åˆ¶é–‹å§‹ã—ã¾ã™');
                    setTimeout(() => {
                        runAllTests();
                    }, 500);
                } else {
                    setTimeout(checkAndRun, 200);
                }
            };
            checkAndRun();
        }
        
        waitAndRunTests();
    </script>
</body>
</html>