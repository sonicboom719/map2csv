<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テスト - 地図→CSV化支援ツール</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🧪 第1段階改善テスト</h1>
    
    <div class="test-section">
        <h2>1. モジュール読み込みテスト</h2>
        <div id="module-test-result"></div>
        <button onclick="testModuleLoading()">モジュール読み込みテスト</button>
    </div>
    
    <div class="test-section">
        <h2>2. 設定外部化テスト</h2>
        <div id="config-test-result"></div>
        <button onclick="testConfig()">設定テスト</button>
    </div>
    
    <div class="test-section">
        <h2>3. エラーハンドリングテスト</h2>
        <div id="error-test-result"></div>
        <button onclick="testErrorHandling()">エラーハンドリングテスト</button>
    </div>
    
    <div class="test-section">
        <h2>4. 座標変換テスト</h2>
        <div id="coordinate-test-result"></div>
        <button onclick="testCoordinateTransformer()">座標変換テスト</button>
    </div>
    
    <div class="test-section">
        <h2>5. 入力履歴テスト</h2>
        <div id="history-test-result"></div>
        <input type="text" id="test-input" placeholder="テスト入力" list="test-datalist">
        <datalist id="test-datalist"></datalist>
        <button onclick="testInputHistory()">履歴テスト</button>
    </div>
    
    <div class="test-section">
        <h2>6. 実際のアプリケーション起動テスト</h2>
        <div id="app-test-result"></div>
        <button onclick="testAppInitialization()">アプリ起動テスト</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { CONFIG, ERROR_MESSAGES } from './js/config.js';
        import { ErrorHandler } from './js/utils/error-handler.js';
        import { CoordinateTransformer } from './js/utils/coordinate-transformer.js';
        import { InputHistoryManager } from './js/input-history.js';
        
        // グローバルに露出（テスト用）
        window.CONFIG = CONFIG;
        window.ERROR_MESSAGES = ERROR_MESSAGES;
        window.ErrorHandler = ErrorHandler;
        window.CoordinateTransformer = CoordinateTransformer;
        window.InputHistoryManager = InputHistoryManager;
        
        function addResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(result);
        }
        
        window.testModuleLoading = function() {
            try {
                if (typeof CONFIG !== 'undefined' && typeof ErrorHandler !== 'undefined') {
                    addResult('module-test-result', 'success', 
                        '✅ すべてのモジュールが正常に読み込まれています');
                } else {
                    addResult('module-test-result', 'error', 
                        '❌ 一部のモジュールが読み込まれていません');
                }
                
                // 具体的な確認
                const modules = {
                    'CONFIG': typeof CONFIG !== 'undefined',
                    'ERROR_MESSAGES': typeof ERROR_MESSAGES !== 'undefined',
                    'ErrorHandler': typeof ErrorHandler !== 'undefined',
                    'CoordinateTransformer': typeof CoordinateTransformer !== 'undefined',
                    'InputHistoryManager': typeof InputHistoryManager !== 'undefined'
                };
                
                for (const [name, loaded] of Object.entries(modules)) {
                    addResult('module-test-result', loaded ? 'success' : 'error', 
                        `${loaded ? '✅' : '❌'} ${name}: ${loaded ? '読み込み済み' : '読み込みエラー'}`);
                }
                
            } catch (error) {
                addResult('module-test-result', 'error', 
                    `❌ モジュール読み込みエラー: ${error.message}`);
            }
        };
        
        window.testConfig = function() {
            try {
                // 設定値の確認
                const tests = [
                    ['UI.MARKER_SIZES.DEFAULT', CONFIG.UI.MARKER_SIZES.DEFAULT, [20, 20]],
                    ['UI.MARKER_SIZES.WITH_NUMBER', CONFIG.UI.MARKER_SIZES.WITH_NUMBER, [25, 25]],
                    ['MAP.DEFAULT_CENTER', CONFIG.MAP.DEFAULT_CENTER, [35.6812, 139.7671]],
                    ['PINS.MAX_DISPLAY_NUMBER', CONFIG.PINS.MAX_DISPLAY_NUMBER, 999],
                    ['HISTORY.MAX_ENTRIES', CONFIG.HISTORY.MAX_ENTRIES, 10]
                ];
                
                let allPassed = true;
                
                for (const [path, actual, expected] of tests) {
                    const passed = JSON.stringify(actual) === JSON.stringify(expected);
                    allPassed = allPassed && passed;
                    
                    addResult('config-test-result', passed ? 'success' : 'error',
                        `${passed ? '✅' : '❌'} ${path}: ${JSON.stringify(actual)} ${passed ? '==' : '!='} ${JSON.stringify(expected)}`);
                }
                
                if (allPassed) {
                    addResult('config-test-result', 'success', '✅ 全ての設定値が正常です');
                }
                
            } catch (error) {
                addResult('config-test-result', 'error', 
                    `❌ 設定テストエラー: ${error.message}`);
            }
        };
        
        window.testErrorHandling = function() {
            try {
                // DOM要素チェックテスト
                try {
                    ErrorHandler.requireElement('nonexistent-element');
                    addResult('error-test-result', 'error', 
                        '❌ 存在しない要素のチェックが正常に動作していません');
                } catch (error) {
                    addResult('error-test-result', 'success', 
                        '✅ 存在しない要素の検出: ' + error.message);
                }
                
                // ネットワークエラー処理テスト
                const networkError = new TypeError('fetch failed');
                const handledError = ErrorHandler.handleNetworkError(networkError);
                
                if (handledError.message === ERROR_MESSAGES.NETWORK_ERROR) {
                    addResult('error-test-result', 'success', 
                        '✅ ネットワークエラーの処理が正常です');
                } else {
                    addResult('error-test-result', 'error', 
                        '❌ ネットワークエラーの処理に問題があります');
                }
                
                // 非同期エラーハンドリングテスト
                ErrorHandler.handleAsyncOperation(async () => {
                    throw new Error('テストエラー');
                }, 'テストコンテキスト').catch(error => {
                    addResult('error-test-result', 'success', 
                        '✅ 非同期エラーハンドリング: ' + error.message);
                });
                
            } catch (error) {
                addResult('error-test-result', 'error', 
                    `❌ エラーハンドリングテストエラー: ${error.message}`);
            }
        };
        
        window.testCoordinateTransformer = function() {
            try {
                // テストデータ
                const imagePoint1 = { x: 100, y: 100 };
                const imagePoint2 = { x: 200, y: 200 };
                const mapPoint1 = { lat: 35.681236, lng: 139.767125 };
                const mapPoint2 = { lat: 35.682236, lng: 139.768125 };
                
                // 変換パラメータ計算
                const transform = CoordinateTransformer.calculateTransform(
                    imagePoint1, imagePoint2, mapPoint1, mapPoint2
                );
                
                if (transform && typeof transform.scaleX === 'number' && typeof transform.scaleY === 'number') {
                    addResult('coordinate-test-result', 'success', 
                        `✅ 変換パラメータ計算成功: scaleX=${transform.scaleX.toFixed(6)}, scaleY=${transform.scaleY.toFixed(6)}`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        '❌ 変換パラメータ計算に失敗しました');
                    return;
                }
                
                // 座標変換テスト
                const [lat, lng] = CoordinateTransformer.transformPoint(150, 150, transform);
                
                if (typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng)) {
                    addResult('coordinate-test-result', 'success', 
                        `✅ 座標変換成功: (150,150) -> (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        '❌ 座標変換結果が無効です');
                }
                
                // 回転角度計算テスト
                const imageVector = { x: 100, y: 100 };
                const mapPixelVector = { x: 100, y: -100 }; // Y軸反転
                const angle = CoordinateTransformer.calculateRotationAngle(imageVector, mapPixelVector);
                
                if (typeof angle === 'number' && !isNaN(angle)) {
                    addResult('coordinate-test-result', 'success', 
                        `✅ 回転角度計算成功: ${(angle * 180 / Math.PI).toFixed(2)}度`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        '❌ 回転角度計算に失敗しました');
                }
                
            } catch (error) {
                addResult('coordinate-test-result', 'error', 
                    `❌ 座標変換テストエラー: ${error.message}`);
            }
        };
        
        window.testInputHistory = function() {
            try {
                const historyManager = new InputHistoryManager();
                const testInput = document.getElementById('test-input');
                
                // 履歴追加テスト
                historyManager.addToHistory('test-field', 'テストエントリ1');
                historyManager.addToHistory('test-field', 'テストエントリ2');
                historyManager.addToHistory('test-field', 'テストエントリ3');
                
                const history = historyManager.getHistory('test-field');
                
                if (history.length === 3 && history[0] === 'テストエントリ3') {
                    addResult('history-test-result', 'success', 
                        '✅ 履歴追加・取得が正常に動作しています');
                } else {
                    addResult('history-test-result', 'error', 
                        `❌ 履歴機能に問題があります: 取得した履歴 = ${JSON.stringify(history)}`);
                }
                
                // 重複排除テスト
                historyManager.addToHistory('test-field', 'テストエントリ1'); // 重複追加
                const historyAfterDuplicate = historyManager.getHistory('test-field');
                
                if (historyAfterDuplicate.length === 3 && historyAfterDuplicate[0] === 'テストエントリ1') {
                    addResult('history-test-result', 'success', 
                        '✅ 重複排除機能が正常に動作しています');
                } else {
                    addResult('history-test-result', 'error', 
                        '❌ 重複排除機能に問題があります');
                }
                
                // LocalStorage確認
                const stored = localStorage.getItem(CONFIG.HISTORY.STORAGE_PREFIX + 'test-field');
                if (stored) {
                    addResult('history-test-result', 'success', 
                        '✅ LocalStorageへの保存が正常に動作しています');
                } else {
                    addResult('history-test-result', 'error', 
                        '❌ LocalStorageへの保存に問題があります');
                }
                
            } catch (error) {
                addResult('history-test-result', 'error', 
                    `❌ 入力履歴テストエラー: ${error.message}`);
            }
        };
        
        window.testAppInitialization = function() {
            try {
                // メインアプリケーションの初期化をシミュレート
                addResult('app-test-result', 'info', 
                    '🔄 アプリケーション初期化テストを開始します...');
                
                // 必要なDOM要素が存在するかチェック（実際のindex.htmlには存在）
                const requiredElements = [
                    'map', 'uploadArea', 'fileInput', 'addressInput', 'searchAddress'
                ];
                
                let missingElements = [];
                
                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        missingElements.push(elementId);
                    }
                }
                
                if (missingElements.length > 0) {
                    addResult('app-test-result', 'info', 
                        `ℹ️ テストページには以下の要素がありません（実際のページでは存在）: ${missingElements.join(', ')}`);
                } else {
                    addResult('app-test-result', 'success', 
                        '✅ 必要なDOM要素が全て存在します');
                }
                
                // 設定値とエラーメッセージの整合性チェック
                if (CONFIG && ERROR_MESSAGES && ErrorHandler && CoordinateTransformer && InputHistoryManager) {
                    addResult('app-test-result', 'success', 
                        '✅ 全てのモジュールがアプリケーション初期化に使用可能です');
                } else {
                    addResult('app-test-result', 'error', 
                        '❌ 一部のモジュールが初期化に失敗しています');
                }
                
                addResult('app-test-result', 'success', 
                    '🎉 基本的なアプリケーション初期化テストが完了しました');
                    
            } catch (error) {
                addResult('app-test-result', 'error', 
                    `❌ アプリ初期化テストエラー: ${error.message}`);
            }
        };
        
        // ページ読み込み時の自動テスト
        document.addEventListener('DOMContentLoaded', function() {
            console.log('テストページが読み込まれました');
            addResult('module-test-result', 'info', 'ℹ️ テストページが準備完了しました。各テストボタンをクリックしてください。');
        });
    </script>
</body>
</html>