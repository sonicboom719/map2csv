<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚¹ãƒˆ - åœ°å›³â†’CSVåŒ–æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ç¬¬1æ®µéšæ”¹å–„ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
        <div id="module-test-result"></div>
        <button onclick="testModuleLoading()">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="test-section">
        <h2>2. è¨­å®šå¤–éƒ¨åŒ–ãƒ†ã‚¹ãƒˆ</h2>
        <div id="config-test-result"></div>
        <button onclick="testConfig()">è¨­å®šãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="test-section">
        <h2>3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</h2>
        <div id="error-test-result"></div>
        <button onclick="testErrorHandling()">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="test-section">
        <h2>4. åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ</h2>
        <div id="coordinate-test-result"></div>
        <button onclick="testCoordinateTransformer()">åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="test-section">
        <h2>5. å…¥åŠ›å±¥æ­´ãƒ†ã‚¹ãƒˆ</h2>
        <div id="history-test-result"></div>
        <input type="text" id="test-input" placeholder="ãƒ†ã‚¹ãƒˆå…¥åŠ›" list="test-datalist">
        <datalist id="test-datalist"></datalist>
        <button onclick="testInputHistory()">å±¥æ­´ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="test-section">
        <h2>6. å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ãƒ†ã‚¹ãƒˆ</h2>
        <div id="app-test-result"></div>
        <button onclick="testAppInitialization()">ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ†ã‚¹ãƒˆ</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { CONFIG, ERROR_MESSAGES } from './js/config.js';
        import { ErrorHandler } from './js/utils/error-handler.js';
        import { CoordinateTransformer } from './js/utils/coordinate-transformer.js';
        import { InputHistoryManager } from './js/input-history.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«éœ²å‡ºï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        window.CONFIG = CONFIG;
        window.ERROR_MESSAGES = ERROR_MESSAGES;
        window.ErrorHandler = ErrorHandler;
        window.CoordinateTransformer = CoordinateTransformer;
        window.InputHistoryManager = InputHistoryManager;
        
        function addResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(result);
        }
        
        window.testModuleLoading = function() {
            try {
                if (typeof CONFIG !== 'undefined' && typeof ErrorHandler !== 'undefined') {
                    addResult('module-test-result', 'success', 
                        'âœ… ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™');
                } else {
                    addResult('module-test-result', 'error', 
                        'âŒ ä¸€éƒ¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // å…·ä½“çš„ãªç¢ºèª
                const modules = {
                    'CONFIG': typeof CONFIG !== 'undefined',
                    'ERROR_MESSAGES': typeof ERROR_MESSAGES !== 'undefined',
                    'ErrorHandler': typeof ErrorHandler !== 'undefined',
                    'CoordinateTransformer': typeof CoordinateTransformer !== 'undefined',
                    'InputHistoryManager': typeof InputHistoryManager !== 'undefined'
                };
                
                for (const [name, loaded] of Object.entries(modules)) {
                    addResult('module-test-result', loaded ? 'success' : 'error', 
                        `${loaded ? 'âœ…' : 'âŒ'} ${name}: ${loaded ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'}`);
                }
                
            } catch (error) {
                addResult('module-test-result', 'error', 
                    `âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        window.testConfig = function() {
            try {
                // è¨­å®šå€¤ã®ç¢ºèª
                const tests = [
                    ['UI.MARKER_SIZES.DEFAULT', CONFIG.UI.MARKER_SIZES.DEFAULT, [20, 20]],
                    ['UI.MARKER_SIZES.WITH_NUMBER', CONFIG.UI.MARKER_SIZES.WITH_NUMBER, [25, 25]],
                    ['MAP.DEFAULT_CENTER', CONFIG.MAP.DEFAULT_CENTER, [35.6812, 139.7671]],
                    ['PINS.MAX_DISPLAY_NUMBER', CONFIG.PINS.MAX_DISPLAY_NUMBER, 999],
                    ['HISTORY.MAX_ENTRIES', CONFIG.HISTORY.MAX_ENTRIES, 10]
                ];
                
                let allPassed = true;
                
                for (const [path, actual, expected] of tests) {
                    const passed = JSON.stringify(actual) === JSON.stringify(expected);
                    allPassed = allPassed && passed;
                    
                    addResult('config-test-result', passed ? 'success' : 'error',
                        `${passed ? 'âœ…' : 'âŒ'} ${path}: ${JSON.stringify(actual)} ${passed ? '==' : '!='} ${JSON.stringify(expected)}`);
                }
                
                if (allPassed) {
                    addResult('config-test-result', 'success', 'âœ… å…¨ã¦ã®è¨­å®šå€¤ãŒæ­£å¸¸ã§ã™');
                }
                
            } catch (error) {
                addResult('config-test-result', 'error', 
                    `âŒ è¨­å®šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        window.testErrorHandling = function() {
            try {
                // DOMè¦ç´ ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
                try {
                    ErrorHandler.requireElement('nonexistent-element');
                    addResult('error-test-result', 'error', 
                        'âŒ å­˜åœ¨ã—ãªã„è¦ç´ ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã›ã‚“');
                } catch (error) {
                    addResult('error-test-result', 'success', 
                        'âœ… å­˜åœ¨ã—ãªã„è¦ç´ ã®æ¤œå‡º: ' + error.message);
                }
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ†ã‚¹ãƒˆ
                const networkError = new TypeError('fetch failed');
                const handledError = ErrorHandler.handleNetworkError(networkError);
                
                if (handledError.message === ERROR_MESSAGES.NETWORK_ERROR) {
                    addResult('error-test-result', 'success', 
                        'âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†ãŒæ­£å¸¸ã§ã™');
                } else {
                    addResult('error-test-result', 'error', 
                        'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
                
                // éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
                ErrorHandler.handleAsyncOperation(async () => {
                    throw new Error('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼');
                }, 'ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ').catch(error => {
                    addResult('error-test-result', 'success', 
                        'âœ… éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ' + error.message);
                });
                
            } catch (error) {
                addResult('error-test-result', 'error', 
                    `âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        window.testCoordinateTransformer = function() {
            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
                const imagePoint1 = { x: 100, y: 100 };
                const imagePoint2 = { x: 200, y: 200 };
                const mapPoint1 = { lat: 35.681236, lng: 139.767125 };
                const mapPoint2 = { lat: 35.682236, lng: 139.768125 };
                
                // å¤‰æ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—
                const transform = CoordinateTransformer.calculateTransform(
                    imagePoint1, imagePoint2, mapPoint1, mapPoint2
                );
                
                if (transform && typeof transform.scaleX === 'number' && typeof transform.scaleY === 'number') {
                    addResult('coordinate-test-result', 'success', 
                        `âœ… å¤‰æ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—æˆåŠŸ: scaleX=${transform.scaleX.toFixed(6)}, scaleY=${transform.scaleY.toFixed(6)}`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        'âŒ å¤‰æ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                // åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
                const [lat, lng] = CoordinateTransformer.transformPoint(150, 150, transform);
                
                if (typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng)) {
                    addResult('coordinate-test-result', 'success', 
                        `âœ… åº§æ¨™å¤‰æ›æˆåŠŸ: (150,150) -> (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        'âŒ åº§æ¨™å¤‰æ›çµæœãŒç„¡åŠ¹ã§ã™');
                }
                
                // å›è»¢è§’åº¦è¨ˆç®—ãƒ†ã‚¹ãƒˆ
                const imageVector = { x: 100, y: 100 };
                const mapPixelVector = { x: 100, y: -100 }; // Yè»¸åè»¢
                const angle = CoordinateTransformer.calculateRotationAngle(imageVector, mapPixelVector);
                
                if (typeof angle === 'number' && !isNaN(angle)) {
                    addResult('coordinate-test-result', 'success', 
                        `âœ… å›è»¢è§’åº¦è¨ˆç®—æˆåŠŸ: ${(angle * 180 / Math.PI).toFixed(2)}åº¦`);
                } else {
                    addResult('coordinate-test-result', 'error', 
                        'âŒ å›è»¢è§’åº¦è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                addResult('coordinate-test-result', 'error', 
                    `âŒ åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        window.testInputHistory = function() {
            try {
                const historyManager = new InputHistoryManager();
                const testInput = document.getElementById('test-input');
                
                // å±¥æ­´è¿½åŠ ãƒ†ã‚¹ãƒˆ
                historyManager.addToHistory('test-field', 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª1');
                historyManager.addToHistory('test-field', 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª2');
                historyManager.addToHistory('test-field', 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª3');
                
                const history = historyManager.getHistory('test-field');
                
                if (history.length === 3 && history[0] === 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª3') {
                    addResult('history-test-result', 'success', 
                        'âœ… å±¥æ­´è¿½åŠ ãƒ»å–å¾—ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                } else {
                    addResult('history-test-result', 'error', 
                        `âŒ å±¥æ­´æ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™: å–å¾—ã—ãŸå±¥æ­´ = ${JSON.stringify(history)}`);
                }
                
                // é‡è¤‡æ’é™¤ãƒ†ã‚¹ãƒˆ
                historyManager.addToHistory('test-field', 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª1'); // é‡è¤‡è¿½åŠ 
                const historyAfterDuplicate = historyManager.getHistory('test-field');
                
                if (historyAfterDuplicate.length === 3 && historyAfterDuplicate[0] === 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒª1') {
                    addResult('history-test-result', 'success', 
                        'âœ… é‡è¤‡æ’é™¤æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                } else {
                    addResult('history-test-result', 'error', 
                        'âŒ é‡è¤‡æ’é™¤æ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
                
                // LocalStorageç¢ºèª
                const stored = localStorage.getItem(CONFIG.HISTORY.STORAGE_PREFIX + 'test-field');
                if (stored) {
                    addResult('history-test-result', 'success', 
                        'âœ… LocalStorageã¸ã®ä¿å­˜ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                } else {
                    addResult('history-test-result', 'error', 
                        'âŒ LocalStorageã¸ã®ä¿å­˜ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
                
            } catch (error) {
                addResult('history-test-result', 'error', 
                    `âŒ å…¥åŠ›å±¥æ­´ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        window.testAppInitialization = function() {
            try {
                // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                addResult('app-test-result', 'info', 
                    'ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
                
                // å¿…è¦ãªDOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã®index.htmlã«ã¯å­˜åœ¨ï¼‰
                const requiredElements = [
                    'map', 'uploadArea', 'fileInput', 'addressInput', 'searchAddress'
                ];
                
                let missingElements = [];
                
                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        missingElements.push(elementId);
                    }
                }
                
                if (missingElements.length > 0) {
                    addResult('app-test-result', 'info', 
                        `â„¹ï¸ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã«ã¯ä»¥ä¸‹ã®è¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã§ã¯å­˜åœ¨ï¼‰: ${missingElements.join(', ')}`);
                } else {
                    addResult('app-test-result', 'success', 
                        'âœ… å¿…è¦ãªDOMè¦ç´ ãŒå…¨ã¦å­˜åœ¨ã—ã¾ã™');
                }
                
                // è¨­å®šå€¤ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                if (CONFIG && ERROR_MESSAGES && ErrorHandler && CoordinateTransformer && InputHistoryManager) {
                    addResult('app-test-result', 'success', 
                        'âœ… å…¨ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã«ä½¿ç”¨å¯èƒ½ã§ã™');
                } else {
                    addResult('app-test-result', 'error', 
                        'âŒ ä¸€éƒ¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆæœŸåŒ–ã«å¤±æ•—ã—ã¦ã„ã¾ã™');
                }
                
                addResult('app-test-result', 'success', 
                    'ğŸ‰ åŸºæœ¬çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                    
            } catch (error) {
                addResult('app-test-result', 'error', 
                    `âŒ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            addResult('module-test-result', 'info', 'â„¹ï¸ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸã€‚å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        });
    </script>
</body>
</html>