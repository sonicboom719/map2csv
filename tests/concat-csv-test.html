<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV結合ツール 拡張テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>CSV結合ツール 拡張テスト（最新仕様対応）</h1>
    
    <button onclick="runAllTests()">全テスト実行</button>
    <div id="results"></div>
    <div id="log" class="log"></div>
    
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script type="module">
        import { ConcatCsv } from '../js/concat-csv.js';
        
        const results = document.getElementById('results');
        const log = document.getElementById('log');
        
        function addResult(name, passed, error = '') {
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? '✓' : '✗'} ${name}${error ? ': ' + error : ''}`;
            results.appendChild(div);
        }
        
        function addLog(message) {
            log.textContent += message + '\n';
        }
        
        // テスト用のCSVデータ（最新仕様：8列対応、prefecture/city統一）
        const csvData1 = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,渋谷区神南,テスト場所1,35.6812,139.7671,備考1
東京都,渋谷区,2,新宿区歌舞伎町,テスト場所2,35.6822,139.7681,備考2`;

        const csvData2 = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,3,港区六本木,テスト場所3,35.6832,139.7691,備考3
東京都,渋谷区,A-1,渋谷区道玄坂,重複場所,35.6842,139.7702,重複備考`;

        // バリデーションエラー用テストデータ
        const invalidHeaderData = `prefecture,city,number,address,name,lat,long,invalidColumn
東京都,渋谷区,1,渋谷区神南,テスト場所1,35.6812,139.7671,備考1`;

        const emptyRequiredFieldData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,,渋谷区神南,テスト場所1,35.6812,139.7671,備考1`;

        const invalidLatLongData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,渋谷区神南,テスト場所1,abc,139.7671,備考1`;

        const outOfRangeLatLongData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,渋谷区神南,テスト場所1,60.0,139.7671,備考1`;

        const inconsistentPrefectureData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,渋谷区神南,テスト場所1,35.6812,139.7671,備考1
大阪府,渋谷区,2,新宿区歌舞伎町,テスト場所2,35.6822,139.7681,備考2`;

        // 基本機能のテスト
        async function testBasicFunctionality() {
            addLog('=== 基本機能テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                // ファイル1を追加
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                const mergedData = concat.getMergedData();
                addLog('ファイル1追加後のデータ数: ' + mergedData.length);
                
                // データ数の確認
                if (mergedData.length !== 2) {
                    throw new Error(`データ数が不正: 期待値2, 実際${mergedData.length}`);
                }
                
                // 必須列の確認（最新仕様：lat, long）
                const firstRow = mergedData[0];
                const requiredFields = ['number', 'name', 'lat', 'long'];
                for (const field of requiredFields) {
                    if (!firstRow.hasOwnProperty(field)) {
                        throw new Error(`必須フィールド${field}が存在しません`);
                    }
                }
                
                // 8列データ構造の確認
                const expectedFields = ['prefecture', 'city', 'number', 'address', 'name', 'lat', 'long', 'note'];
                for (const field of expectedFields) {
                    if (!firstRow.hasOwnProperty(field)) {
                        throw new Error(`期待フィールド${field}が存在しません`);
                    }
                }
                
                addResult('基本機能テスト', true);
            } catch (error) {
                addResult('基本機能テスト', false, error.message);
            }
        }

        // マージ機能のテスト
        async function testMergeFunctionality() {
            addLog('=== マージ機能テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                const file2 = new File([csvData2], 'test2.csv', { type: 'text/csv' });
                
                await concat.addFile(file1);
                await concat.addFile(file2);
                
                const mergedData = concat.getMergedData();
                addLog('マージ後のデータ数: ' + mergedData.length);
                
                if (mergedData.length !== 4) {
                    throw new Error(`マージ後のデータ数が不正: 期待値4, 実際${mergedData.length}`);
                }
                
                // 市区町村名の検出確認
                const cityName = concat.getCityName();
                if (!cityName) {
                    throw new Error('市区町村名が検出されていません');
                }
                addLog('検出された市区町村名: ' + cityName);
                
                addResult('マージ機能テスト', true);
            } catch (error) {
                addResult('マージ機能テスト', false, error.message);
            }
        }

        // ソート機能のテスト
        async function testSortFunctionality() {
            addLog('=== ソート機能テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                const file2 = new File([csvData2], 'test2.csv', { type: 'text/csv' });
                
                await concat.addFile(file1);
                await concat.addFile(file2);
                
                // 文字列ソートのテスト（address第1キー + number第2キー）
                concat.setSortType('string');
                let sortedData = concat.getMergedData();
                addLog('文字列ソート結果（address→number）:');
                sortedData.forEach((row, i) => {
                    addLog(`  ${i+1}: ${row.address} : ${row.number}`);
                });
                
                // 数値ソートのテスト（address第1キー + number第2キー）
                concat.setSortType('numeric');
                sortedData = concat.getMergedData();
                addLog('数値ソート結果（address→number）:');
                sortedData.forEach((row, i) => {
                    addLog(`  ${i+1}: ${row.address} : ${row.number}`);
                });
                
                // ソートなしのテスト
                concat.setSortType('none');
                sortedData = concat.getMergedData();
                addLog('ソートなし結果: ' + sortedData.map(d => d.number).join(', '));
                
                addResult('ソート機能テスト', true);
            } catch (error) {
                addResult('ソート機能テスト', false, error.message);
            }
        }

        // addressソート機能の詳細テスト
        async function testAddressSortLogic() {
            addLog('=== addressソート機能テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                // 「*区」混在データのテスト
                const mixedAddressData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,渋谷区神南,場所1,35.6812,139.7671,備考1
東京都,新宿区,2,新宿区歌舞伎町,場所2,35.6822,139.7681,備考2
東京都,港区,3,港区六本木,場所3,35.6832,139.7691,備考3
東京都,千代田区,4,東京都千代田区丸の内,場所4,35.6842,139.7702,備考4`;
                
                const file = new File([mixedAddressData], 'mixed_address.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                concat.setSortType('string');
                const sortedData = concat.getMergedData();
                
                addLog('addressソート結果:');
                sortedData.forEach((row, index) => {
                    addLog(`  ${index + 1}: ${row.address} (${row.name})`);
                });
                
                // compareAddress関数の動作確認
                const testCases = [
                    ['渋谷区神南', '新宿区歌舞伎町'],
                    ['港区六本木', '東京都千代田区丸の内'],
                ];
                
                testCases.forEach(([a, b]) => {
                    const result = concat.compareAddress(a, b);
                    addLog(`compareAddress("${a}", "${b}") = ${result}`);
                });
                
                addResult('addressソート機能テスト', true);
            } catch (error) {
                addResult('addressソート機能テスト', false, error.message);
            }
        }

        // CSVエクスポートのテスト
        async function testCsvExport() {
            addLog('=== CSVエクスポートテスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                // CSVエクスポート
                const csvOutput = concat.exportToCsv();
                addLog('エクスポートされたCSV:');
                addLog(csvOutput.substring(0, 200) + '...');
                
                // ヘッダーの確認（8列対応）
                const lines = csvOutput.trim().split('\n');
                const header = lines[0].trim();
                const expectedHeader = 'prefecture,city,number,address,name,lat,long,note';
                
                if (header !== expectedHeader) {
                    throw new Error(`ヘッダーが不正: 期待値"${expectedHeader}", 実際"${header}"`);
                }
                
                addResult('CSVエクスポートテスト', true);
            } catch (error) {
                addResult('CSVエクスポートテスト', false, error.message);
            }
        }

        // プレビュー機能のテスト
        async function testPreviewFunctionality() {
            addLog('=== プレビュー機能テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                // データなしの場合
                let previewHtml = concat.generatePreviewTable();
                addLog('データなし時のプレビュー長: ' + previewHtml.length);
                
                // データありの場合
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                previewHtml = concat.generatePreviewTable();
                addLog('データあり時のプレビュー長: ' + previewHtml.length);
                
                // HTMLにtableタグが含まれているか確認
                if (!previewHtml.includes('<table')) {
                    throw new Error('プレビューHTMLにtableタグが含まれていません');
                }
                
                // 8列のヘッダーが含まれているか確認
                const expectedHeaders = ['prefecture', 'city', 'number', 'address', 'name', 'lat', 'long', 'note'];
                for (const header of expectedHeaders) {
                    if (!previewHtml.includes(`>${header}<`)) {
                        throw new Error(`プレビューHTMLに${header}ヘッダーが含まれていません`);
                    }
                }
                
                addResult('プレビュー機能テスト', true);
            } catch (error) {
                addResult('プレビュー機能テスト', false, error.message);
            }
        }

        // 市区町村名検出のテスト
        async function testCityNameDetection() {
            addLog('=== 市区町村名検出テスト ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                const cityName = concat.getCityName();
                if (!cityName) {
                    throw new Error('市区町村名が検出されていません');
                }
                
                addLog('検出された市区町村名: ' + cityName);
                
                // 最初に見つかった市区町村名（渋谷区）が検出されることを確認
                if (cityName !== '渋谷区') {
                    throw new Error(`期待された市区町村名と異なります: 期待値渋谷区, 実際${cityName}`);
                }
                
                addResult('市区町村名検出テスト', true);
            } catch (error) {
                addResult('市区町村名検出テスト', false, error.message);
            }
        }

        // バリデーションテスト
        async function testValidation() {
            addLog('=== バリデーションテスト ===');
            
            // 1. 無効なヘッダーテスト
            try {
                const concat = new ConcatCsv();
                const file = new File([invalidHeaderData], 'invalid_header.csv', { type: 'text/csv' });
                await concat.addFile(file);
                addResult('無効ヘッダーテスト', false, '例外が発生しませんでした');
            } catch (error) {
                if (error.message.includes('許可されていない列があります')) {
                    addResult('無効ヘッダーテスト', true);
                    addLog('期待通りのエラー: ' + error.message);
                } else {
                    addResult('無効ヘッダーテスト', false, '予期しないエラー: ' + error.message);
                }
            }
            
            // 2. 必須フィールド空テスト
            try {
                const concat = new ConcatCsv();
                const file = new File([emptyRequiredFieldData], 'empty_required.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                // ファイルは追加されるがデータはマージされない
                const mergedData = concat.getMergedData();
                if (mergedData.length === 0) {
                    addResult('必須フィールド空テスト', true);
                    addLog('期待通り: エラーファイルのデータはマージされませんでした');
                } else {
                    addResult('必須フィールド空テスト', false, 'エラーファイルのデータがマージされました');
                }
            } catch (error) {
                addResult('必須フィールド空テスト', false, '予期しないエラー: ' + error.message);
            }
            
            // 3. 無効なlat/longテスト
            try {
                const concat = new ConcatCsv();
                const file = new File([invalidLatLongData], 'invalid_latlong.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                const mergedData = concat.getMergedData();
                if (mergedData.length === 0) {
                    addResult('無効lat/longテスト', true);
                    addLog('期待通り: 無効なlat/longファイルのデータはマージされませんでした');
                } else {
                    addResult('無効lat/longテスト', false, '無効なlat/longファイルのデータがマージされました');
                }
            } catch (error) {
                addResult('無効lat/longテスト', false, '予期しないエラー: ' + error.message);
            }
            
            // 4. 範囲外lat/longテスト
            try {
                const concat = new ConcatCsv();
                const file = new File([outOfRangeLatLongData], 'outofrange_latlong.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                const mergedData = concat.getMergedData();
                if (mergedData.length === 0) {
                    addResult('範囲外lat/longテスト', true);
                    addLog('期待通り: 範囲外lat/longファイルのデータはマージされませんでした');
                } else {
                    addResult('範囲外lat/longテスト', false, '範囲外lat/longファイルのデータがマージされました');
                }
            } catch (error) {
                addResult('範囲外lat/longテスト', false, '予期しないエラー: ' + error.message);
            }
            
            // 5. prefecture不一致テスト
            try {
                const concat = new ConcatCsv();
                const file = new File([inconsistentPrefectureData], 'inconsistent_prefecture.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                const mergedData = concat.getMergedData();
                if (mergedData.length === 0) {
                    addResult('prefecture不一致テスト', true);
                    addLog('期待通り: prefecture不一致ファイルのデータはマージされませんでした');
                } else {
                    addResult('prefecture不一致テスト', false, 'prefecture不一致ファイルのデータがマージされました');
                }
            } catch (error) {
                addResult('prefecture不一致テスト', false, '予期しないエラー: ' + error.message);
            }
            
            // 6. 空文字列許可テスト（address, name, note）
            try {
                const allowedEmptyData = `prefecture,city,number,address,name,lat,long,note
東京都,渋谷区,1,,,35.6812,139.7671,
東京都,渋谷区,2,渋谷区神南,,35.6822,139.7681,備考2`;
                
                const concat = new ConcatCsv();
                const file = new File([allowedEmptyData], 'allowed_empty.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                const mergedData = concat.getMergedData();
                if (mergedData.length === 2) {
                    addResult('空文字列許可テスト', true);
                    addLog('期待通り: address/name/noteの空文字列は許可されました');
                } else {
                    addResult('空文字列許可テスト', false, 'address/name/noteの空文字列が拒否されました');
                }
            } catch (error) {
                addResult('空文字列許可テスト', false, '予期しないエラー: ' + error.message);
            }
        }

        // すべてのテストを実行
        window.runAllTests = async function() {
            results.innerHTML = '';
            log.textContent = '';
            addLog('CSV結合ツール 拡張テスト開始（最新バリデーション仕様対応）\n');
            
            try {
                await testBasicFunctionality();
                await testMergeFunctionality();
                await testSortFunctionality();
                await testAddressSortLogic();
                await testCsvExport();
                await testPreviewFunctionality();
                await testCityNameDetection();
                await testValidation();
                
                addLog('\n🎉 すべてのテストが成功しました！');
            } catch (error) {
                addLog('\n❌ テストが失敗しました: ' + error.message);
                console.error(error);
            }
        };
        
        // ページ読み込み時に自動実行
        window.addEventListener('load', () => {
            runAllTests();
        });
    </script>
</body>
</html>