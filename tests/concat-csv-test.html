<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµåˆãƒ„ãƒ¼ãƒ« æ‹¡å¼µãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>CSVçµåˆãƒ„ãƒ¼ãƒ« æ‹¡å¼µãƒ†ã‚¹ãƒˆï¼ˆæœ€æ–°ä»•æ§˜å¯¾å¿œï¼‰</h1>
    
    <button onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="results"></div>
    <div id="log" class="log"></div>
    
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script type="module">
        import { ConcatCsv } from '../js/concat-csv.js';
        
        const results = document.getElementById('results');
        const log = document.getElementById('log');
        
        function addResult(name, passed, error = '') {
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? 'âœ“' : 'âœ—'} ${name}${error ? ': ' + error : ''}`;
            results.appendChild(div);
        }
        
        function addLog(message) {
            log.textContent += message + '\n';
        }
        
        // ãƒ†ã‚¹ãƒˆç”¨ã®CSVãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€æ–°ä»•æ§˜ï¼š8åˆ—å¯¾å¿œï¼‰
        const csvData1 = `prefecture,city,number,address,name,lat,long,note
æ±äº¬éƒ½,æ¸‹è°·åŒº,1,æ¸‹è°·åŒºç¥å—,ãƒ†ã‚¹ãƒˆå ´æ‰€1,35.6812,139.7671,å‚™è€ƒ1
æ±äº¬éƒ½,æ–°å®¿åŒº,2,æ–°å®¿åŒºæ­Œèˆä¼ç”º,ãƒ†ã‚¹ãƒˆå ´æ‰€2,35.6822,139.7681,å‚™è€ƒ2`;

        const csvData2 = `prefecture,city,number,address,name,lat,long,note
æ±äº¬éƒ½,æ¸¯åŒº,3,æ¸¯åŒºå…­æœ¬æœ¨,ãƒ†ã‚¹ãƒˆå ´æ‰€3,35.6832,139.7691,å‚™è€ƒ3
æ±äº¬éƒ½,æ¸‹è°·åŒº,A-1,æ¸‹è°·åŒºé“ç„å‚,é‡è¤‡å ´æ‰€,35.6842,139.7702,é‡è¤‡å‚™è€ƒ`;

        // åŸºæœ¬æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
        async function testBasicFunctionality() {
            addLog('=== åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«1ã‚’è¿½åŠ 
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                const mergedData = concat.getMergedData();
                addLog('ãƒ•ã‚¡ã‚¤ãƒ«1è¿½åŠ å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•°: ' + mergedData.length);
                
                // ãƒ‡ãƒ¼ã‚¿æ•°ã®ç¢ºèª
                if (mergedData.length !== 2) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿æ•°ãŒä¸æ­£: æœŸå¾…å€¤2, å®Ÿéš›${mergedData.length}`);
                }
                
                // å¿…é ˆåˆ—ã®ç¢ºèªï¼ˆæœ€æ–°ä»•æ§˜ï¼šlat, longï¼‰
                const firstRow = mergedData[0];
                const requiredFields = ['number', 'name', 'lat', 'long'];
                for (const field of requiredFields) {
                    if (!firstRow.hasOwnProperty(field)) {
                        throw new Error(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${field}ãŒå­˜åœ¨ã—ã¾ã›ã‚“`);
                    }
                }
                
                // 8åˆ—ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ç¢ºèª
                const expectedFields = ['prefecture', 'city', 'number', 'address', 'name', 'lat', 'long', 'note'];
                for (const field of expectedFields) {
                    if (!firstRow.hasOwnProperty(field)) {
                        throw new Error(`æœŸå¾…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${field}ãŒå­˜åœ¨ã—ã¾ã›ã‚“`);
                    }
                }
                
                addResult('åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // ãƒãƒ¼ã‚¸æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
        async function testMergeFunctionality() {
            addLog('=== ãƒãƒ¼ã‚¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                const file2 = new File([csvData2], 'test2.csv', { type: 'text/csv' });
                
                await concat.addFile(file1);
                await concat.addFile(file2);
                
                const mergedData = concat.getMergedData();
                addLog('ãƒãƒ¼ã‚¸å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•°: ' + mergedData.length);
                
                if (mergedData.length !== 4) {
                    throw new Error(`ãƒãƒ¼ã‚¸å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•°ãŒä¸æ­£: æœŸå¾…å€¤4, å®Ÿéš›${mergedData.length}`);
                }
                
                // å¸‚åŒºç”ºæ‘åã®æ¤œå‡ºç¢ºèª
                const cityName = concat.getCityName();
                if (!cityName) {
                    throw new Error('å¸‚åŒºç”ºæ‘åãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                addLog('æ¤œå‡ºã•ã‚ŒãŸå¸‚åŒºç”ºæ‘å: ' + cityName);
                
                addResult('ãƒãƒ¼ã‚¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('ãƒãƒ¼ã‚¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
        async function testSortFunctionality() {
            addLog('=== ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                const file2 = new File([csvData2], 'test2.csv', { type: 'text/csv' });
                
                await concat.addFile(file1);
                await concat.addFile(file2);
                
                // æ–‡å­—åˆ—ã‚½ãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆï¼ˆaddressç¬¬1ã‚­ãƒ¼ + numberç¬¬2ã‚­ãƒ¼ï¼‰
                concat.setSortType('string');
                let sortedData = concat.getMergedData();
                addLog('æ–‡å­—åˆ—ã‚½ãƒ¼ãƒˆçµæœï¼ˆaddressâ†’numberï¼‰:');
                sortedData.forEach((row, i) => {
                    addLog(`  ${i+1}: ${row.address} : ${row.number}`);
                });
                
                // æ•°å€¤ã‚½ãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆï¼ˆaddressç¬¬1ã‚­ãƒ¼ + numberç¬¬2ã‚­ãƒ¼ï¼‰
                concat.setSortType('numeric');
                sortedData = concat.getMergedData();
                addLog('æ•°å€¤ã‚½ãƒ¼ãƒˆçµæœï¼ˆaddressâ†’numberï¼‰:');
                sortedData.forEach((row, i) => {
                    addLog(`  ${i+1}: ${row.address} : ${row.number}`);
                });
                
                // ã‚½ãƒ¼ãƒˆãªã—ã®ãƒ†ã‚¹ãƒˆ
                concat.setSortType('none');
                sortedData = concat.getMergedData();
                addLog('ã‚½ãƒ¼ãƒˆãªã—çµæœ: ' + sortedData.map(d => d.number).join(', '));
                
                addResult('ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // addressã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã®è©³ç´°ãƒ†ã‚¹ãƒˆ
        async function testAddressSortLogic() {
            addLog('=== addressã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                // ã€Œ*åŒºã€æ··åœ¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ
                const mixedAddressData = `prefecture,city,number,address,name,lat,long,note
æ±äº¬éƒ½,æ¸‹è°·åŒº,1,æ¸‹è°·åŒºç¥å—,å ´æ‰€1,35.6812,139.7671,å‚™è€ƒ1
æ±äº¬éƒ½,æ–°å®¿åŒº,2,æ–°å®¿åŒºæ­Œèˆä¼ç”º,å ´æ‰€2,35.6822,139.7681,å‚™è€ƒ2
æ±äº¬éƒ½,æ¸¯åŒº,3,æ¸¯åŒºå…­æœ¬æœ¨,å ´æ‰€3,35.6832,139.7691,å‚™è€ƒ3
æ±äº¬éƒ½,åƒä»£ç”°åŒº,4,æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…,å ´æ‰€4,35.6842,139.7702,å‚™è€ƒ4`;
                
                const file = new File([mixedAddressData], 'mixed_address.csv', { type: 'text/csv' });
                await concat.addFile(file);
                
                concat.setSortType('string');
                const sortedData = concat.getMergedData();
                
                addLog('addressã‚½ãƒ¼ãƒˆçµæœ:');
                sortedData.forEach((row, index) => {
                    addLog(`  ${index + 1}: ${row.address} (${row.name})`);
                });
                
                // compareAddressé–¢æ•°ã®å‹•ä½œç¢ºèª
                const testCases = [
                    ['æ¸‹è°·åŒºç¥å—', 'æ–°å®¿åŒºæ­Œèˆä¼ç”º'],
                    ['æ¸¯åŒºå…­æœ¬æœ¨', 'æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…'],
                ];
                
                testCases.forEach(([a, b]) => {
                    const result = concat.compareAddress(a, b);
                    addLog(`compareAddress("${a}", "${b}") = ${result}`);
                });
                
                addResult('addressã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('addressã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆ
        async function testCsvExport() {
            addLog('=== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                const csvOutput = concat.exportToCsv();
                addLog('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸCSV:');
                addLog(csvOutput.substring(0, 200) + '...');
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèªï¼ˆ8åˆ—å¯¾å¿œï¼‰
                const lines = csvOutput.split('\n');
                const header = lines[0];
                const expectedHeader = 'prefecture,city,number,address,name,lat,long,note';
                
                if (header !== expectedHeader) {
                    throw new Error(`ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£: æœŸå¾…å€¤${expectedHeader}, å®Ÿéš›${header}`);
                }
                
                addResult('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
        async function testPreviewFunctionality() {
            addLog('=== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                // ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆ
                let previewHtml = concat.generatePreviewTable();
                addLog('ãƒ‡ãƒ¼ã‚¿ãªã—æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é•·: ' + previewHtml.length);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šã®å ´åˆ
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                previewHtml = concat.generatePreviewTable();
                addLog('ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é•·: ' + previewHtml.length);
                
                // HTMLã«tableã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!previewHtml.includes('<table')) {
                    throw new Error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã«tableã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // 8åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const expectedHeaders = ['prefecture', 'city', 'number', 'address', 'name', 'lat', 'long', 'note'];
                for (const header of expectedHeaders) {
                    if (!previewHtml.includes(`>${header}<`)) {
                        throw new Error(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã«${header}ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“`);
                    }
                }
                
                addResult('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // å¸‚åŒºç”ºæ‘åæ¤œå‡ºã®ãƒ†ã‚¹ãƒˆ
        async function testCityNameDetection() {
            addLog('=== å¸‚åŒºç”ºæ‘åæ¤œå‡ºãƒ†ã‚¹ãƒˆ ===');
            
            try {
                const concat = new ConcatCsv();
                
                const file1 = new File([csvData1], 'test1.csv', { type: 'text/csv' });
                await concat.addFile(file1);
                
                const cityName = concat.getCityName();
                if (!cityName) {
                    throw new Error('å¸‚åŒºç”ºæ‘åãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                addLog('æ¤œå‡ºã•ã‚ŒãŸå¸‚åŒºç”ºæ‘å: ' + cityName);
                
                // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸå¸‚åŒºç”ºæ‘åï¼ˆæ¸‹è°·åŒºï¼‰ãŒæ¤œå‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
                if (cityName !== 'æ¸‹è°·åŒº') {
                    throw new Error(`æœŸå¾…ã•ã‚ŒãŸå¸‚åŒºç”ºæ‘åã¨ç•°ãªã‚Šã¾ã™: æœŸå¾…å€¤æ¸‹è°·åŒº, å®Ÿéš›${cityName}`);
                }
                
                addResult('å¸‚åŒºç”ºæ‘åæ¤œå‡ºãƒ†ã‚¹ãƒˆ', true);
            } catch (error) {
                addResult('å¸‚åŒºç”ºæ‘åæ¤œå‡ºãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        window.runAllTests = async function() {
            results.innerHTML = '';
            log.textContent = '';
            addLog('CSVçµåˆãƒ„ãƒ¼ãƒ« æ‹¡å¼µãƒ†ã‚¹ãƒˆé–‹å§‹\n');
            
            try {
                await testBasicFunctionality();
                await testMergeFunctionality();
                await testSortFunctionality();
                await testAddressSortLogic();
                await testCsvExport();
                await testPreviewFunctionality();
                await testCityNameDetection();
                
                addLog('\nğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼');
            } catch (error) {
                addLog('\nâŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                console.error(error);
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            runAllTests();
        });
    </script>
</body>
</html>