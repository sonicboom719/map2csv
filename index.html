<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ポスター地図→CSV化支援ツール</title>
	
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	
	<!-- Remove distortable image plugin as it's causing issues -->
	
	<!-- Custom CSS -->
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<!-- 左サイドパネル -->
	<div class="sidebar" id="sidebar">
		<h1>地図→CSV化支援ツール</h1>
		
		<!-- 画像アップロードセクション -->
		<div class="section">
			<h2>1. 地図画像をアップロード</h2>
			<div class="upload-area" id="uploadArea">
				<p>画像をドラッグ＆ドロップ<br>または<br>CLICKして選択<br>または<br>Ctrl+Vでペースト</p>
				<input type="file" id="fileInput" accept="image/*,.pdf" style="display: none;">
			</div>
			<div id="uploadedImage" class="uploaded-image" style="display: none;">
				<img id="previewImage" alt="アップロード画像">
			</div>
		</div>
		
		<!-- 住所入力セクション -->
		<div class="section">
			<h2>2. 地図画像のエリアを入力</h2>
			<input type="text" id="addressInput" placeholder="例: 東京都千代田区永田町">
		</div>
		
		<!-- オーバーレイ制御セクション -->
		<div class="section" id="overlaySection" style="display: none;">
			<h2>3. 画像の位置合わせ</h2>
			<div class="transform-mode-selector" style="margin-bottom: 15px;">
				<select id="transformMode" style="padding: 5px;">
					<option value="2point" selected>2点合わせ（スケール・回転）</option>
					<option value="3point">3点合わせ（アフィン変換）</option>
					<option value="4point">4点合わせ（射影変換）</option>
				</select>
			</div>
			<p class="info">STEP1: 青ウィンドウで2点選択 → STEP2: 地図で対応する2点選択 → STEP3: 位置合わせ実行</p>
			<div class="point-selection">
				<div class="point-status">
					<h3>画像上の点</h3>
					<div id="imagePoints" class="points-list"></div>
				</div>
				<div class="point-status">
					<h3>地図上の点</h3>
					<div id="mapPoints" class="points-list"></div>
				</div>
			</div>
			<button id="applyTransform" class="btn-primary" disabled>位置合わせを実行</button>
			<button id="resetPoints" class="btn-secondary">選択をリセット</button>
		</div>
	</div>
	
	<div class="container">
		<!-- 地図エリア -->
		<div class="map-container">
			<div id="map"></div>
			<!-- 地図タイル選択パネル -->
			<div id="mapTileSelector" class="map-tile-selector">
				<label class="tile-option">
					<input type="radio" name="mapTile" value="osm" checked>
					<span>OpenStreetMap</span>
				</label>
				<label class="tile-option">
					<input type="radio" name="mapTile" value="gsi-standard">
					<span>GSI標準地図</span>
				</label>
				<label class="tile-option">
					<input type="radio" name="mapTile" value="gsi-pale">
					<span>GSI淡色地図</span>
				</label>
			</div>
			<!-- 画像選択用キャンバス -->
			<canvas id="imageCanvas" style="display: none;"></canvas>
		</div>
	</div>
	
	<!-- 左サイドバー用トグルボタン -->
	<button id="leftSidebarToggle" class="sidebar-toggle left open" title="アップロード・設定パネルを閉じる">
		<span class="arrow">‹</span>
	</button>
	
	<!-- 右サイドバー用トグルボタン -->
	<button id="rightSidebarToggle" class="sidebar-toggle" title="ピン管理パネルを開く">
		<span class="arrow">‹</span>
	</button>
	
	<!-- 右サイドパネル -->
	<div class="right-sidebar" id="rightSidebar">
		<!-- ピン管理セクション -->
		<div class="section" id="pinSection">
			<h2>4. ピンを配置</h2>
			<p class="info">地図上をCLICKでピン配置、長押しでピン配置と編集、既存ピンはCLICKで編集</p>
			<div style="margin: 10px 0;">
				<label style="display: flex; align-items: center; font-size: 14px;">
					<input type="checkbox" id="autoNumberingCheckbox" checked style="margin-right: 8px;">
					ピン番号を自動で連番付与する
				</label>
			</div>
			<div style="margin: 10px 0;">
				<select id="pinDisplayType" style="padding: 5px; font-size: 14px;">
					<option value="displayNumber">ピン番号をピンに表示</option>
					<option value="pinNumber">掲示場番号をピンに表示</option>
				</select>
			</div>
			<div id="pinList" class="pin-list"></div>
			<div style="margin-top: 15px;">
				<!-- 互換性のためのhidden inputs -->
				<input type="hidden" id="prefectureInput">
				<input type="hidden" id="cityInput">
				<button id="exportCsv" class="btn-primary">CSVエクスポート</button>
				<button id="importCsv" class="btn-secondary" style="margin-top: 10px;">CSVインポート</button>
				<div style="margin-top: 10px; text-align: center;">
					<a href="concat_csv.html" target="_blank" style="color: #3498db; text-decoration: none; font-size: 14px;">
						→ 複数のCSVファイルを結合する
					</a>
				</div>
			</div>
		</div>
	</div>
	
	<!-- ピン情報入力モーダル -->
	<div id="pinModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>ピン情報を入力</h3>
			<label>
				ピン番号（表示用）:
				<select id="pinDisplayNumber">
					<option value="">選択してください(省略可)</option>
				</select>
			</label>
			<label>
				掲示場番号:
				<input type="text" id="pinNumber" placeholder="例: A-1">
			</label>
			<label>
				場所名称:
				<input type="text" id="pinName" placeholder="例: ○○公園">
			</label>
			<label>
				メモ:
				<textarea id="pinMemo" placeholder="任意のメモ"></textarea>
			</label>
			<div class="modal-buttons">
				<button id="savePinInfo" style="flex: 1; height: 40px; background-color: #3498db; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; margin: 0;">保存</button>
				<button id="cancelPinInfo" style="flex: 1; height: 40px; background-color: #95a5a6; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; margin: 0;">キャンセル</button>
			</div>
		</div>
	</div>

	<!-- CSVエクスポート設定モーダル -->
	<div id="csvExportModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>📄 CSVエクスポート設定</h3>
			<label>
				都道府県:
				<input type="text" id="exportPrefecture" placeholder="例: 東京都">
			</label>
			<label>
				市区町村:
				<input type="text" id="exportCity" placeholder="例: 千代田区">
			</label>
			<label>
				ファイル名末尾 (_normalized以降):
				<input type="text" id="exportSuffix" placeholder="例: _001" value="">
			</label>
			<div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 14px; color: #666;">
				<strong>プレビュー:</strong> <span id="filenamePreview">sample_normalized.csv</span>
			</div>
			<div class="modal-buttons">
				<button id="executeExport" class="btn-primary" style="flex: 1; height: 40px; background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; margin: 0;">エクスポートを実行</button>
				<button id="cancelExport" style="flex: 1; height: 40px; background-color: #95a5a6; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; margin: 0;">キャンセル</button>
			</div>
		</div>
	</div>

	<!-- CSVインポート設定モーダル -->
	<div id="csvImportModal" class="modal" style="display: none;">
		<div class="modal-content" style="min-width: 500px;">
			<h3>📥 CSVインポート設定</h3>
			
			<!-- ファイル選択（非表示） -->
			<input type="file" id="csvFileInput" accept=".csv" style="display: none;">
			
			<!-- ファイル情報表示 -->
			<div id="fileInfo" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
				<strong>選択ファイル:</strong> <span id="fileName"></span><br>
				<strong>データ件数:</strong> <span id="dataCount"></span>件
			</div>
			
			<!-- 列選択 -->
			<div id="columnSelection" style="display: none;">
				<h4 style="margin-bottom: 10px;">インポートする列を選択してください：</h4>
				<div id="columnCheckboxes" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
					<!-- チェックボックスが動的に追加される -->
				</div>
				
				<!-- 必須列の確認 -->
				<div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-radius: 4px; font-size: 14px;">
					<strong>注意:</strong> lat（緯度）とlong（経度）は必須列です。
				</div>
				
				<!-- 既存ピンの処理方法 -->
				<div style="margin-bottom: 15px;">
					<h4 style="margin-bottom: 10px;">既存ピンの処理方法：</h4>
					<label style="display: flex; align-items: center; margin-bottom: 8px;">
						<input type="radio" name="importMode" value="append" checked style="margin-right: 8px;">
						既存ピンに追加する
					</label>
					<label style="display: flex; align-items: center;">
						<input type="radio" name="importMode" value="clear" style="margin-right: 8px;">
						既存ピンをクリアして新規作成
					</label>
				</div>
			</div>
			
			<div class="modal-buttons">
				<button id="executeImport" class="btn-primary" style="background-color: #27ae60;" disabled>インポートを実行</button>
				<button id="cancelImport" class="btn-secondary">キャンセル</button>
			</div>
		</div>
	</div>
	
	<!-- Scripts -->
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
	<script>
		pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
	</script>
	<!-- OpenCV.js -->
	<script>
		var Module = {
			onRuntimeInitialized: function() {
				console.log('OpenCV.js is ready');
				window.cvReady = true;
				// OpenCV.js準備完了イベントを発行
				window.dispatchEvent(new Event('opencv-ready'));
			}
		};
	</script>
	<script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>
	<script src="js/main.js" type="module"></script>
</body>
</html>