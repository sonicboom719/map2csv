<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>リサイズハンドルテスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #testCanvas {
            position: fixed;
            top: 100px;
            left: 300px;
            border: 2px solid #3498db;
            border-radius: 4px;
            cursor: move;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .resize-handle {
            position: fixed;
            width: 24px;
            height: 24px;
            background: #3498db;
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            z-index: 1500;
            transition: all 0.2s ease;
        }
        
        .resize-handle:hover {
            transform: scale(1.3);
            background: #2980b9;
        }
        
        .resize-nw { cursor: nw-resize; }
        .resize-ne { cursor: ne-resize; }
        .resize-se { cursor: se-resize; }
        .resize-sw { cursor: sw-resize; }
        
        .info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
    </style>
</head>
<body>
    <div class="info">
        <h3>🔧 リサイズハンドル表示テスト</h3>
        <p><strong>テスト内容:</strong></p>
        <ul>
            <li>キャンバスの4隅に青い丸が表示されるか</li>
            <li>青い丸をドラッグしてリサイズできるか</li>
            <li>ホバー時に青い丸が拡大するか</li>
        </ul>
        <button onclick="createHandles()">リサイズハンドルを作成</button>
        <button onclick="logPositions()">位置をコンソールに出力</button>
    </div>
    
    <canvas id="testCanvas" width="300" height="200"></canvas>
    
    <script>
        let canvas = document.getElementById('testCanvas');
        let handles = [];
        
        // キャンバスに画像を描画
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#333';
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('テスト画像', canvas.width/2, canvas.height/2);
        
        function createHandles() {
            console.log('Creating resize handles...');
            
            // 既存のハンドルを削除
            handles.forEach(handle => handle.remove());
            handles = [];
            
            const canvasRect = canvas.getBoundingClientRect();
            console.log('Canvas position:', canvasRect);
            
            const handlePositions = [
                { pos: 'nw', left: canvasRect.left - 12, top: canvasRect.top - 12 },
                { pos: 'ne', left: canvasRect.right - 12, top: canvasRect.top - 12 },
                { pos: 'se', left: canvasRect.right - 12, top: canvasRect.bottom - 12 },
                { pos: 'sw', left: canvasRect.left - 12, top: canvasRect.bottom - 12 }
            ];
            
            handlePositions.forEach(info => {
                const handle = document.createElement('div');
                handle.className = `resize-handle resize-${info.pos}`;
                handle.style.left = info.left + 'px';
                handle.style.top = info.top + 'px';
                
                handle.addEventListener('mousedown', (e) => {
                    console.log(`Handle ${info.pos} clicked`);
                    startResize(e, info.pos, handle);
                });
                
                document.body.appendChild(handle);
                handles.push(handle);
                
                console.log(`Created handle ${info.pos} at (${info.left}, ${info.top})`);
            });
            
            console.log(`Created ${handles.length} handles`);
        }
        
        function startResize(e, position, handle) {
            console.log(`Starting resize with ${position} handle`);
            
            let startX = e.clientX;
            let startY = e.clientY;
            let startWidth = canvas.width;
            let startHeight = canvas.height;
            
            const handleResize = (e) => {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                
                switch(position) {
                    case 'se':
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'sw':
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'ne':
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight - deltaY;
                        break;
                    case 'nw':
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight - deltaY;
                        break;
                }
                
                newWidth = Math.max(150, Math.min(600, newWidth));
                newHeight = Math.max(100, Math.min(400, newHeight));
                
                canvas.width = newWidth;
                canvas.height = newHeight;
                
                // 再描画
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, newWidth, newHeight);
                ctx.fillStyle = '#333';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('リサイズ中', newWidth/2, newHeight/2);
                
                updateHandlePositions();
            };
            
            const stopResize = () => {
                console.log('Resize ended');
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            };
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        function updateHandlePositions() {
            const canvasRect = canvas.getBoundingClientRect();
            
            if (handles.length >= 4) {
                handles[0].style.left = (canvasRect.left - 12) + 'px';
                handles[0].style.top = (canvasRect.top - 12) + 'px';
                
                handles[1].style.left = (canvasRect.right - 12) + 'px';
                handles[1].style.top = (canvasRect.top - 12) + 'px';
                
                handles[2].style.left = (canvasRect.right - 12) + 'px';
                handles[2].style.top = (canvasRect.bottom - 12) + 'px';
                
                handles[3].style.left = (canvasRect.left - 12) + 'px';
                handles[3].style.top = (canvasRect.bottom - 12) + 'px';
            }
        }
        
        function logPositions() {
            const canvasRect = canvas.getBoundingClientRect();
            console.log('Canvas rect:', canvasRect);
            handles.forEach((handle, index) => {
                const rect = handle.getBoundingClientRect();
                console.log(`Handle ${index}:`, rect);
            });
        }
        
        // 初期ハンドル作成
        setTimeout(() => {
            createHandles();
        }, 500);
    </script>
</body>
</html>