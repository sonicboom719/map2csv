# 地図→CSV化支援ツール

地図画像やPDFを地図上に重ね合わせて、ポスター掲示場の位置にピンを配置し、データをCSV形式で出力するWebツールです。

## 📖 使い方ガイド

### ステップ1: 画像のアップロード

1. **ファイルを選択**
   - 「画像を選択」ボタンをクリック、またはファイルをドラッグ&ドロップ
   - クリップボードからの貼り付けも可能（Ctrl+V）

2. **対応ファイル形式**
   - PDF ファイル（自動的に画像に変換）
   - 画像ファイル（PNG、JPEG、GIF など）

### ステップ2: 地図エリアの設定

1. **住所を入力**
   - 画像の撮影エリアに近い住所を入力
   - 例：「東京都渋谷区神南1-15-3」

2. **地図を移動**
   - 「地図を移動」ボタンをクリック
   - 地図が該当エリアに自動移動

### ステップ3: 画像の位置合わせ（2点対応方式）

1. **画像上で2点を選択**
   - 青いウィンドウで画像が表示される
   - 道路の交差点や建物の角など、特徴的な2つの点をクリック
   - 点はドラッグで微調整可能

2. **地図上で対応点を選択**
   - 画像で選択した点と同じ場所を地図上でクリック
   - 点はドラッグで微調整可能

3. **位置合わせを実行**
   - 「位置合わせを実行」ボタンをクリック
   - 画像が地図上に重ね合わされます

### ステップ4: 掲示場ピンの配置

1. **ピンを配置**
   - 地図上の掲示場の位置をクリック
   - ピンが配置され、情報入力ダイアログが開く

2. **掲示場情報を入力**
   - **ピン番号**: マップ上に表示される番号（1-999）
   - **掲示場番号**: CSV出力用の識別番号
   - **掲示場名**: 掲示場や場所の名前
   - **メモ**: 補足情報（改行不可）

3. **ピンの管理**
   - 右サイドバーにピン一覧が表示
   - ピンはドラッグで位置変更可能
   - リストとマップ間でのハイライト連動

### ステップ5: データのエクスポート

1. **都道府県・市区町村を入力**
   - CSV出力用の地域情報を入力

2. **CSVダウンロード**
   - 「正規化CSVダウンロード」ボタンをクリック
   - ファイル名：`{市区町村名}_normalized_yyyymmddhhmmss.csv`

## 🔗 CSV結合ツール

複数の正規化CSVファイルを結合・マージする専用ツールです。

### アクセス方法
- メインツールの左下「→ CSV結合ツールへ」をクリック
- または右サイドバーのリンクから直接アクセス

### 使い方

1. **CSVファイルアップロード**
   - 複数の正規化CSVファイルをドラッグ&ドロップまたは選択
   - ファイル一覧で追加されたファイルを確認

2. **ソート設定**
   - **なし**: 元の順序を維持
   - **numberの辞書順**: 住所→番号（文字列）でソート
   - **numberの数値の昇順**: 住所→番号（数値）でソート

3. **プレビュー確認**
   - 結合されたデータを8列（prefecture, city, number, address, name, lat, long, note）で表示
   - 件数表示で総データ数を確認

4. **CSV出力**
   - 市区町村名が自動検出されファイル名に反映
   - 統合されたCSVファイルをダウンロード

### 高度なソート機能

- **addressソート**: 住所が「*区」で終わる場合は区名部分を、それ以外は住所全体をソートキーとして使用
- **numberソート**: 「A-1-2」のような複雑なパターンも数値部分を正しく認識

## 💡 便利な機能

### 画像表示コントロール
- **透明度調整**: スライダーで画像の透明度を変更
- **表示/非表示**: 画像の表示をON/OFF切り替え
- **元画像表示**: 大きなサイズで元画像を確認
- **位置調整**: 配置をやり直し

### インタラクティブ操作
- **マップ ↔ リスト連動**: ピンにマウスオーバーでリストがハイライト
- **ドラッグ操作**: ピンや調整点をドラッグで移動
- **自動回転補正**: 画像と地図の向きの違いを自動調整

## 📋 出力データ形式

CSV出力項目：
```
prefecture,city,number,address,name,lat,long,note
```

- **prefecture**: 都道府県
- **city**: 市区町村
- **number**: 掲示場番号
- **address**: 住所（空白）
- **name**: 掲示場名
- **lat**: 緯度
- **long**: 経度
- **note**: メモ

## ⚠️ 注意事項

- **インターネット接続必須**: 地図表示にOpenStreetMapを使用
- **データ保存なし**: ブラウザリロード時にデータは消失
- **大容量ファイル**: 大きなPDFや画像の処理には時間がかかる場合があります

## 🔧 技術情報

### 使用技術
- **地図**: Leaflet.js + OpenStreetMap
- **PDF処理**: PDF.js
- **CSV生成**: PapaParser
- **住所検索**: Nominatim API

### 対応ブラウザ
- Chrome, Firefox, Safari, Edge（最新版推奨）
- JavaScript有効が必要

## 📁 ファイル構成

```
map2csv/
├── index.html                   # メインページ
├── concat_csv.html              # CSV結合ツール
├── css/style.css               # スタイルシート
├── js/
│   ├── main.js                 # アプリケーション制御
│   ├── concat-csv.js           # CSV結合機能
│   ├── map.js                  # 地図管理
│   ├── uploader.js             # ファイルアップロード
│   ├── overlay-simple-clean.js # 画像オーバーレイ管理
│   ├── simple-drag-resize.js   # ウィンドウ管理
│   ├── pins.js                 # ピン管理
│   └── export.js               # CSV出力
├── tests/
│   ├── concat-csv-test.html    # CSV結合ツールのテスト
│   ├── integration-test.html   # 統合テスト
│   ├── unit-tests.html         # ユニットテスト
│   └── simple-test.js          # テストフレームワーク
└── CLAUDE.md                   # 技術仕様書
```

## 🧪 テスト

### テストの実行

1. **統合テスト**
   - `tests/integration-test.html` をブラウザで開く
   - アプリケーション全体の初期化と連携をテスト

2. **ユニットテスト**
   - `tests/unit-tests.html` をブラウザで開く
   - 個別コンポーネントの機能をテスト

### テスト項目
- DOM要素の存在確認
- 各マネージャークラスの初期化
- 設定ファイルの整合性
- ユーティリティ関数の動作
- モジュールの読み込み確認

---

© TeamMirai - ポスター掲示場管理支援ツール