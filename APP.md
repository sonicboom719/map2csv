# クライアント完結型「地図オーバーレイ＆ピン打ちCSV出力」Webアプリ開発指示書

## 概要

- ユーザーが**PDF地図画像（例：選挙ポスター掲示場マップ）または画像（PNG/JPG）をアップロード**できる。
- さらに、**スクリーンショットでコピーした画像を「ペースト操作（Ctrl+V等）」でそのままアップロード**できる。
- **概ねの住所（地図の中心付近など）をフォームに入力できる**。
- Googleマップ（またはOpenStreetMap）上に**半透明オーバーレイ**として表示。
- 必要に応じて**画像の位置・大きさ・回転・射影変換**（最低4点で台形補正）で地図を合わせる。
- 掲示場等のポイントを**ピンとして地図上に複数設置できる**。
- 各ピンには「掲示番号」などの**付加情報（テキスト）を入力・編集可能**。
- **全ピン情報（緯度・経度・付加情報）をCSVでダウンロード**できる。
- すべてクライアントサイド（静的サイト）で完結し、サーバーやDBは不要。

---

## 必須要件

1. **PDF地図画像または画像のアップロード（JPG/PNG変換可）**
    - 画像ファイル（PDF, PNG, JPG）をブラウザで読み込み、地図上に半透明で重ねる
    - PDFの場合は最初のページを画像化して利用

2. **スクリーンショット画像のペーストアップロード対応**
    - ユーザーが**クリップボードにコピーした画像（スクリーンショット等）を、アプリ画面上で「Ctrl+V」や「ペースト操作」でアップロード**できる
    - ペーストされた画像は通常の画像アップロードと同等に扱う

3. **概ねの住所入力機能**
    - 画像アップロード後、ユーザーが「地図の中心付近の住所やランドマーク名」をテキストフォームに入力できる
    - 入力した住所をもとにジオコーディング（Google Maps Geocoding APIやNominatim等で緯度経度変換）し、ベース地図の中心に自動移動・ズーム

4. **地図オーバーレイ＋射影変換（最低4点指定）**
    - ユーザーが「画像上で4点」「地図上で4点」を対応付けて指定
    - この4点に基づいて射影変換（台形補正）し、オーバーレイ画像を地図上に表示
    - 変換にはCanvasまたは適切なJSライブラリ（例：opencv.jsやLeaflet.DistortableImage等）を活用

5. **地図ピン打ち・付加情報**
    - 地図上をクリックしてピン（マーカー）を設置
    - ピンごとに掲示番号・メモなどテキスト情報を追加・編集できる
    - ピンの削除や移動も可能

6. **CSVエクスポート**
    - 現在の全ピンの「緯度・経度・付加情報」をCSVとしてダウンロード

7. **静的サイト構成（サーバーサイド不要）**
    - index.html、main.js、style.cssなどで完結
    - 配布や運用はGitHub Pages等で可能な構成

---

## 推奨技術・ライブラリ

- 地図描画：Leaflet.js または Google Maps JavaScript API
- ジオコーディング：Nominatim API（OpenStreetMap）、Google Geocoding API など
- 画像オーバーレイ・変形：Leaflet.DistortableImage または opencv.js
- CSV生成：JavaScriptのFile API、または PapaParse等のライブラリ
- **クリップボード画像のペースト検出：JavaScriptのClipboard APIまたはPasteイベントのImage対応**

---

## 画面イメージ

1. 地図表示エリア
    - 地図上に画像オーバーレイ
    - ピン設置・編集機能
2. 画像アップロード＆特徴点指定パネル
    - ファイル選択・ドラッグ＆ドロップ・ペーストで画像受付
    - 住所入力フォーム（住所やランドマーク名を入力→地図中心移動）
    - 「画像上で特徴点クリック」→「地図上で対応点クリック」方式
3. ピン情報リスト＋CSVエクスポートボタン

---

## 動作手順フロー

1. PDF/画像アップロード **またはクリップボード画像のペースト**
2. **概ねの住所入力→地図中心が自動移動**
3. 画像の特徴点4点指定 → 地図の対応点4点指定
4. 「オーバーレイ実行」ボタンで射影変換・半透明表示
5. 地図上でピン打ち、情報入力・編集
6. CSVダウンロード

---

## 補足

- ピンデータ等は全てクライアントのメモリ内で管理し、サーバー送信禁止
- オーバーレイ画像は縮尺・角度が変わっても地図上に追従
- CSVのカラム例：`latitude,longitude,掲示番号,メモ`
- 住所入力時のジオコーディングには無料のNominatim API推奨（ただし利用制限に注意）
- **画像ペーストはPasteイベントでimage/png, image/jpeg等のMIME型を検出し、画像データとして処理すること**

---

## 参考OSS・ドキュメント

- [Leaflet.js公式](https://leafletjs.com/)
- [Leaflet.DistortableImageプラグイン](https://github.com/publiclab/Leaflet.DistortableImage)
- [PapaParse](https://www.papaparse.com/)
- [Nominatim API](https://nominatim.openstreetmap.org/ui/search.html)
- [Clipboard API (MDN)](https://developer.mozilla.org/ja/docs/Web/API/Clipboard_API)
- [Google Maps Geocoding API](https://developers.google.com/maps/documentation/geocoding/overview)

---

## 要望まとめ

- **静的サイトのみで地図オーバーレイ・ピン打ち・CSV出力ができること**
- **PDF（画像）から特徴点4点指定→地図上4点指定で、射影変換によるオーバーレイ精度にこだわること**
- **概ねの住所入力で地図中心を素早く移動できること**
- **スクリーンショット等の画像をCtrl+Vやペースト操作で直接アップロードできること**
- **UI/UXは可能な限りシンプルにすること**

---
